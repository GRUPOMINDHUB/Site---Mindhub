<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title }} - Mindhub OS</title>

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PIXEL ART STYLE - ALTA DEFINIÃ‡ÃƒO
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            -ms-interpolation-mode: nearest-neighbor;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            min-height: 100vh;
            background: #87CEEB;
            overflow-x: hidden;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TEMAS DOS MESES - CSS VARIABLES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --mindhub-red: #e30613;
        }

        /* MÃŠS 1: DESERTO DE OURO */
        [data-theme="deserto-ouro"] {
            --sky-top: #87CEEB;
            --sky-bottom: #c9e4f5;
            --ground: #d4a574;
            --ground-dark: #b8944c;
            --path: #c9a45c;
            --path-border: #8b6914;
            --accent: #ffd700;
            --tree-trunk: #5a3a1a;
            --tree-leaves: #228b22;
        }

        /* MÃŠS 2: REINO DOS DOCES */
        [data-theme="reino-doces"] {
            --sky-top: #ffb6c1;
            --sky-bottom: #ffe4e1;
            --ground: #d2691e;
            --ground-dark: #8b4513;
            --path: #ffe4c4;
            --path-border: #deb887;
            --accent: #ff69b4;
            --tree-trunk: #8b4513;
            --tree-leaves: #ff69b4;
        }

        /* MÃŠS 3: ZEN SUSHI */
        [data-theme="zen-sushi"] {
            --sky-top: #1a1a2e;
            --sky-bottom: #16213e;
            --ground: #2d4a3e;
            --ground-dark: #1a3028;
            --path: #4a3728;
            --path-border: #2f1f14;
            --accent: #dc143c;
            --tree-trunk: #2f1f14;
            --tree-leaves: #2d5a4a;
        }

        /* MÃŠS 4: METRÃ“POLE BURGER */
        [data-theme="metropole-burger"] {
            --sky-top: #1a1a2e;
            --sky-bottom: #2d2d44;
            --ground: #333333;
            --ground-dark: #1a1a1a;
            --path: #444444;
            --path-border: #222222;
            --accent: #ff4500;
            --tree-trunk: #333333;
            --tree-leaves: #2d4a2d;
        }

        /* MÃŠS 5: TOSCANA PIZZA */
        [data-theme="toscana-pizza"] {
            --sky-top: #87CEEB;
            --sky-bottom: #b0d4e8;
            --ground: #7cb342;
            --ground-dark: #558b2f;
            --path: #8b7355;
            --path-border: #5c4a32;
            --accent: #8b0000;
            --tree-trunk: #5a3a1a;
            --tree-leaves: #2e7d32;
        }

        /* MÃŠS 6: IMPÃ‰RIO GOURMET */
        [data-theme="imperio-gourmet"] {
            --sky-top: #1a1a3a;
            --sky-bottom: #2a2a5a;
            --ground: #1a1a2e;
            --ground-dark: #0a0a1e;
            --path: #8b0000;
            --path-border: #4a0000;
            --accent: #ffd700;
            --tree-trunk: #2a2a4a;
            --tree-leaves: #1a3a1a;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PIXEL SKY BACKGROUND
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .pixel-sky {
            position: fixed;
            inset: 0;
            background: linear-gradient(180deg, var(--sky-top) 0%, var(--sky-bottom) 100%);
            z-index: -3;
        }

        .pixel-clouds {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            z-index: -2;
            overflow: hidden;
        }

        .cloud {
            position: absolute;
            animation: cloudMove 60s linear infinite;
        }

        @keyframes cloudMove {
            0% {
                transform: translateX(-200px);
            }

            100% {
                transform: translateX(calc(100vw + 200px));
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HUD - TOP BAR PIXEL STYLE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .hud {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background:
                linear-gradient(180deg, #228b22 0%, #1a6b1a 50%, #145214 100%);
            border-bottom: 4px solid #0a3a0a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 4px 0 #0a3a0a;
        }

        .hud-left,
        .hud-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 12px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
            letter-spacing: 2px;
        }

        .mes-badge {
            padding: 6px 12px;
            background: var(--accent);
            border: 3px solid #fff;
            box-shadow: 3px 3px 0 #000;
            font-size: 8px;
            color: #000;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .btn-sair {
            padding: 8px 16px;
            background: #cc0000;
            border: 3px solid #fff;
            box-shadow: 3px 3px 0 #000;
            font-family: inherit;
            font-size: 8px;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        .btn-sair:hover {
            background: #ff0000;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAP CONTAINER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .map-container {
            padding: 80px 20px 40px;
            display: flex;
            flex-direction: column;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MÃŠS BIOMA - PIXEL ISLAND
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .mes-island {
            position: relative;
            background: var(--ground);
            border: 4px solid var(--ground-dark);
            border-radius: 0;
            padding: 20px;
            box-shadow:
                0 8px 0 var(--ground-dark),
                0 12px 0 rgba(0, 0, 0, 0.3),
                inset 0 -20px 40px rgba(0, 0, 0, 0.1);
        }

        /* Grass edge top */
        .mes-island::before {
            content: '';
            position: absolute;
            top: -12px;
            left: 0;
            right: 0;
            height: 16px;
            background:
                repeating-linear-gradient(90deg,
                    transparent 0px, transparent 8px,
                    #4a9828 8px, #4a9828 12px,
                    transparent 12px, transparent 16px,
                    #3a7818 16px, #3a7818 20px,
                    transparent 20px, transparent 24px);
            clip-path: polygon(0% 100%, 2% 40%, 4% 100%, 6% 30%, 8% 100%,
                    10% 50%, 12% 100%, 14% 20%, 16% 100%, 18% 40%, 20% 100%,
                    22% 30%, 24% 100%, 26% 50%, 28% 100%, 30% 20%, 32% 100%,
                    34% 40%, 36% 100%, 38% 30%, 40% 100%, 42% 50%, 44% 100%,
                    46% 20%, 48% 100%, 50% 40%, 52% 100%, 54% 30%, 56% 100%,
                    58% 50%, 60% 100%, 62% 20%, 64% 100%, 66% 40%, 68% 100%,
                    70% 30%, 72% 100%, 74% 50%, 76% 100%, 78% 20%, 80% 100%,
                    82% 40%, 84% 100%, 86% 30%, 88% 100%, 90% 50%, 92% 100%,
                    94% 20%, 96% 100%, 98% 40%, 100% 100%);
        }

        .mes-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.4);
            border: 3px solid var(--accent);
        }

        .mes-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .mes-number {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border: 3px solid #fff;
            box-shadow: 3px 3px 0 #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #000;
        }

        .mes-name {
            font-size: 14px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .mes-progress {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 10px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .progress-bar {
            width: 100px;
            height: 12px;
            background: #333;
            border: 2px solid #000;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.5s;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PIXEL SVG TRILHA
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .trilha-svg {
            width: 100%;
            height: 300px;
            overflow: visible;
        }

        /* Path layers */
        .path-border {
            fill: none;
            stroke: var(--path-border);
            stroke-width: 32;
            stroke-linecap: square;
        }

        .path-main {
            fill: none;
            stroke: var(--path);
            stroke-width: 26;
            stroke-linecap: square;
        }

        .path-detail {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 4;
            stroke-dasharray: 8 16;
            stroke-linecap: square;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           STEP NODES - PIXEL STYLE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .step-node {
            cursor: pointer;
            transition: transform 0.1s steps(2);
        }

        .step-node:hover {
            transform: scale(1.15);
        }

        .step-node.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .step-node.locked:hover {
            transform: none;
        }

        .step-node.current {
            animation: pixelPulse 0.5s steps(2) infinite;
        }

        @keyframes pixelPulse {

            0%,
            100% {
                filter: brightness(1);
            }

            50% {
                filter: brightness(1.4) drop-shadow(0 0 8px var(--accent));
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DECORAÃ‡Ã•ES PIXEL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .pixel-tree {
            position: absolute;
            z-index: 5;
        }

        .pixel-cactus {
            position: absolute;
            z-index: 4;
        }

        .pixel-bush {
            position: absolute;
            z-index: 3;
        }

        .pixel-flower {
            position: absolute;
            z-index: 2;
            animation: flowerBounce 1s steps(2) infinite;
        }

        @keyframes flowerBounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-2px);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DRAWER - PAINEL LATERAL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .drawer-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .drawer {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 100%;
            max-width: 380px;
            background:
                linear-gradient(180deg, #228b22 0%, #1a6b1a 100%);
            border-left: 4px solid #0a3a0a;
            z-index: 2001;
            transform: translateX(100%);
            transition: transform 0.2s;
            overflow-y: auto;
        }

        .drawer.active {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 20px;
            background: var(--mindhub-red);
            border-bottom: 4px solid #990000;
        }

        .drawer-title {
            font-size: 12px;
            color: #fff;
            text-shadow: 2px 2px 0 #000;
        }

        .drawer-close {
            position: absolute;
            right: 15px;
            top: 15px;
            width: 32px;
            height: 32px;
            background: #000;
            border: 3px solid #fff;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

        .drawer-body {
            padding: 20px;
        }

        .info-card {
            background: rgba(0, 0, 0, 0.4);
            border: 3px solid #fff;
            padding: 15px;
            margin-bottom: 15px;
        }

        .info-card h3 {
            font-size: 10px;
            color: var(--accent);
            margin-bottom: 10px;
            text-shadow: 1px 1px 0 #000;
        }

        .info-card p {
            font-size: 12px;
            color: #fff;
            line-height: 1.8;
            font-family: 'Segoe UI', sans-serif;
        }

        .xp-badge {
            display: inline-block;
            padding: 8px 16px;
            background: var(--accent);
            border: 3px solid #fff;
            box-shadow: 3px 3px 0 #000;
            font-size: 10px;
            color: #000;
            margin-bottom: 15px;
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: var(--mindhub-red);
            border: 4px solid #fff;
            box-shadow: 4px 4px 0 #000;
            font-family: inherit;
            font-size: 10px;
            color: #fff;
            cursor: pointer;
            text-shadow: 2px 2px 0 #000;
        }

        .btn-submit:hover {
            background: #ff0000;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        .form-field {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #fff;
            color: #fff;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
            margin-bottom: 12px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           IA BUTTON
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .ia-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: var(--mindhub-red);
            border: 4px solid #fff;
            box-shadow: 4px 4px 0 #000;
            font-size: 24px;
            cursor: pointer;
            z-index: 1500;
        }

        .ia-btn:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVO
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 768px) {
            .hud {
                padding: 0 10px;
                height: 50px;
            }

            .logo {
                font-size: 10px;
            }

            .mes-badge {
                display: none;
            }

            .mes-name {
                font-size: 10px;
            }

            .trilha-svg {
                height: 220px;
            }
        }
    </style>
</head>

<body data-theme="deserto-ouro">
    <!-- Pixel Sky -->
    <div class="pixel-sky"></div>

    <!-- Pixel Clouds -->
    <div class="pixel-clouds">
        <svg class="cloud" style="top:30px;animation-delay:0s;" width="96" height="48" viewBox="0 0 96 48">
            <rect x="24" y="24" width="48" height="20" fill="#fff" />
            <rect x="32" y="16" width="32" height="12" fill="#fff" />
            <rect x="16" y="28" width="12" height="12" fill="#fff" />
            <rect x="68" y="28" width="12" height="12" fill="#fff" />
            <rect x="40" y="12" width="16" height="8" fill="#fff" />
        </svg>
        <svg class="cloud" style="top:80px;animation-delay:-20s;" width="80" height="40" viewBox="0 0 80 40">
            <rect x="20" y="20" width="40" height="16" fill="#fff" />
            <rect x="26" y="12" width="28" height="12" fill="#fff" />
            <rect x="12" y="24" width="10" height="10" fill="#fff" />
            <rect x="58" y="24" width="10" height="10" fill="#fff" />
        </svg>
        <svg class="cloud" style="top:50px;animation-delay:-40s;" width="72" height="36" viewBox="0 0 72 36">
            <rect x="18" y="18" width="36" height="14" fill="#fff" />
            <rect x="24" y="10" width="24" height="10" fill="#fff" />
            <rect x="10" y="22" width="10" height="10" fill="#fff" />
            <rect x="52" y="22" width="10" height="10" fill="#fff" />
        </svg>
    </div>

    <!-- HUD -->
    <header class="hud">
        <div class="hud-left">
            <span class="logo">ğŸ½ï¸ MINDHUB</span>
            <span class="mes-badge" id="mes-badge">MÃŠS 1</span>
        </div>
        <div class="hud-right">
            <span class="stat-item">â­ <span id="xp">0</span> XP</span>
            <span class="stat-item">ğŸ“Š <span id="progress">0/0</span></span>
            <a href="/logout" class="btn-sair">SAIR</a>
        </div>
    </header>

    <!-- Map Container -->
    <main class="map-container" id="map"></main>

    <!-- Drawer -->
    <div class="drawer-overlay" id="overlay"></div>
    <aside class="drawer" id="drawer">
        <div class="drawer-header">
            <span class="drawer-title" id="drawer-title">ETAPA</span>
            <button class="drawer-close" onclick="closeDrawer()">Ã—</button>
        </div>
        <div class="drawer-body" id="drawer-body"></div>
    </aside>

    <!-- IA Button -->
    <button class="ia-btn" onclick="alert('ğŸ§  MindLink - Em breve!')">ğŸ§ </button>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TEMAS DOS MESES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const TEMAS = {
            1: { slug: 'deserto-ouro', nome: 'DESERTO DE OURO', icon: 'ğŸœï¸' },
            2: { slug: 'reino-doces', nome: 'REINO DOS DOCES', icon: 'ğŸ­' },
            3: { slug: 'zen-sushi', nome: 'ZEN SUSHI', icon: 'ğŸ£' },
            4: { slug: 'metropole-burger', nome: 'METRÃ“POLE BURGER', icon: 'ğŸ”' },
            5: { slug: 'toscana-pizza', nome: 'TOSCANA PIZZA', icon: 'ğŸ•' },
            6: { slug: 'imperio-gourmet', nome: 'IMPÃ‰RIO GOURMET', icon: 'ğŸ‘‘' }
        };

        let avatarNode = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SET THEME
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setTheme(mesNumero) {
            const tema = TEMAS[mesNumero] || TEMAS[1];
            document.body.setAttribute('data-theme', tema.slug);
            document.getElementById('mes-badge').textContent = `MÃŠS ${mesNumero}`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER PIXEL STEP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderPixelStep(step) {
            let fillColor, borderColor, icon;

            switch (step.status) {
                case 'BLOQUEADO':
                    fillColor = '#555';
                    borderColor = '#333';
                    icon = 'ğŸ”’';
                    break;
                case 'EM_ANDAMENTO':
                    fillColor = '#ffd700';
                    borderColor = '#daa520';
                    icon = 'ğŸ¯';
                    break;
                case 'CONCLUIDO':
                    fillColor = '#4ade80';
                    borderColor = '#22c55e';
                    icon = 'âœ“';
                    break;
                case 'PENDENTE_VALIDACAO':
                    fillColor = '#fbbf24';
                    borderColor = '#f59e0b';
                    icon = 'â³';
                    break;
                default:
                    fillColor = '#555';
                    borderColor = '#333';
                    icon = '?';
            }

            return `
                <rect x="-24" y="-24" width="48" height="48" fill="${fillColor}" stroke="${borderColor}" stroke-width="4"/>
                <rect x="-20" y="-20" width="40" height="40" fill="${fillColor}"/>
                <rect x="-18" y="-18" width="8" height="8" fill="rgba(255,255,255,0.3)"/>
                <text text-anchor="middle" dominant-baseline="central" font-size="20" fill="#fff" style="text-shadow:2px 2px 0 #000">${icon}</text>
            `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER PIXEL CASTLE - ESTILO DETALHADO
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderPixelCastle(mesNumero, completed) {
            const mainColor = completed ? '#ffd700' : '#d4a574';
            const darkColor = completed ? '#daa520' : '#b8944c';
            const accentColor = completed ? '#ff8c00' : '#c9a45c';

            return `
                <g class="pixel-castle">
                    <!-- Base Foundation -->
                    <rect x="-80" y="50" width="160" height="20" fill="${darkColor}"/>
                    <rect x="-85" y="65" width="170" height="10" fill="#5a3a1a"/>
                    
                    <!-- Main Building -->
                    <rect x="-65" y="-10" width="130" height="60" fill="${mainColor}" stroke="${darkColor}" stroke-width="3"/>
                    
                    <!-- Stone Pattern -->
                    ${[...Array(5)].map((_, i) => `
                        <line x1="-65" y1="${-10 + i * 14}" x2="65" y2="${-10 + i * 14}" stroke="${darkColor}" stroke-width="1" opacity="0.4"/>
                    `).join('')}
                    
                    <!-- Left Tower -->
                    <rect x="-75" y="-50" width="30" height="100" fill="${mainColor}" stroke="${darkColor}" stroke-width="3"/>
                    <rect x="-80" y="-55" width="10" height="8" fill="${mainColor}" stroke="${darkColor}" stroke-width="2"/>
                    <rect x="-65" y="-55" width="10" height="8" fill="${mainColor}" stroke="${darkColor}" stroke-width="2"/>
                    <rect x="-50" y="-55" width="10" height="8" fill="${mainColor}" stroke="${darkColor}" stroke-width="2"/>
                    <!-- Tower Window -->
                    <rect x="-68" y="-30" width="16" height="24" rx="8" fill="#4a3728"/>
                    <rect x="-66" y="-28" width="12" height="20" rx="6" fill="#2a1a08"/>
                    
                    <!-- Right Tower -->
                    <rect x="45" y="-50" width="30" height="100" fill="${mainColor}" stroke="${darkColor}" stroke-width="3"/>
                    <rect x="40" y="-55" width="10" height="8" fill="${mainColor}" stroke="${darkColor}" stroke-width="2"/>
                    <rect x="55" y="-55" width="10" height="8" fill="${mainColor}" stroke="${darkColor}" stroke-width="2"/>
                    <rect x="70" y="-55" width="10" height="8" fill="${mainColor}" stroke="${darkColor}" stroke-width="2"/>
                    <!-- Tower Window -->
                    <rect x="52" y="-30" width="16" height="24" rx="8" fill="#4a3728"/>
                    <rect x="54" y="-28" width="12" height="20" rx="6" fill="#2a1a08"/>
                    
                    <!-- Center Tower -->
                    <rect x="-25" y="-40" width="50" height="90" fill="${mainColor}" stroke="${darkColor}" stroke-width="3"/>
                    
                    <!-- Roof/Dome -->
                    <polygon points="0,-70 -30,-40 30,-40" fill="${accentColor}" stroke="${darkColor}" stroke-width="3"/>
                    <rect x="-5" y="-80" width="10" height="12" fill="${accentColor}"/>
                    <polygon points="0,-90 -8,-80 8,-80" fill="${accentColor}"/>
                    
                    <!-- Main Archway Door -->
                    <rect x="-18" y="10" width="36" height="40" rx="18" fill="#4a3728" stroke="#2a1a08" stroke-width="3"/>
                    <rect x="-14" y="14" width="28" height="36" rx="14" fill="#2a1a08"/>
                    <!-- Door Details -->
                    <line x1="0" y1="14" x2="0" y2="50" stroke="#1a0a00" stroke-width="2"/>
                    <circle cx="-6" cy="35" r="3" fill="${completed ? '#ffd700' : '#8b6914'}"/>
                    <circle cx="6" cy="35" r="3" fill="${completed ? '#ffd700' : '#8b6914'}"/>
                    
                    <!-- Windows on Main Building -->
                    <rect x="-55" y="5" width="14" height="20" rx="7" fill="#4a3728"/>
                    <rect x="41" y="5" width="14" height="20" rx="7" fill="#4a3728"/>
                    
                    <!-- Battlements -->
                    ${[-60, -45, -30, 30, 45, 60].map(x => `
                        <rect x="${x - 6}" y="-16" width="12" height="8" fill="${mainColor}" stroke="${darkColor}" stroke-width="2"/>
                    `).join('')}
                    
                    <!-- Flags -->
                    <line x1="-60" y1="-55" x2="-60" y2="-75" stroke="#5a3a1a" stroke-width="3"/>
                    <polygon points="-60,-75 -45,-70 -60,-65" fill="${completed ? '#ffd700' : '#cc0000'}"/>
                    <line x1="60" y1="-55" x2="60" y2="-75" stroke="#5a3a1a" stroke-width="3"/>
                    <polygon points="60,-75 75,-70 60,-65" fill="${completed ? '#ffd700' : '#cc0000'}"/>
                    
                    <!-- Sign -->
                    <rect x="-45" y="58" width="90" height="22" fill="#5a3a1a" stroke="#3a2a0a" stroke-width="2"/>
                    <text x="0" y="73" text-anchor="middle" font-size="8" fill="#ffd700" font-family="'Press Start 2P'">CASTELO ${mesNumero}</text>
                    
                    ${completed ? `
                        <text x="0" y="-100" text-anchor="middle" font-size="24">ğŸ‘‘</text>
                    ` : ''}
                </g>
            `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER PIXEL AVATAR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderPixelAvatar(mesNumero) {
            return `
                <g class="pixel-avatar" style="animation: avatarBounce 0.6s steps(2) infinite;">
                    <style>
                        @keyframes avatarBounce {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(-6px); }
                        }
                    </style>
                    <!-- Shadow -->
                    <ellipse cx="0" cy="10" rx="12" ry="4" fill="rgba(0,0,0,0.3)"/>
                    <!-- Body -->
                    <rect x="-10" y="-20" width="20" height="28" fill="#fff" stroke="#ddd" stroke-width="2"/>
                    <!-- Buttons -->
                    <rect x="-2" y="-14" width="4" height="4" fill="#333"/>
                    <rect x="-2" y="-6" width="4" height="4" fill="#333"/>
                    <!-- Head -->
                    <rect x="-12" y="-40" width="24" height="22" fill="#ffd5c8" stroke="#e8c4b8" stroke-width="2"/>
                    <!-- Eyes -->
                    <rect x="-8" y="-36" width="6" height="6" fill="#333"/>
                    <rect x="2" y="-36" width="6" height="6" fill="#333"/>
                    <rect x="-6" y="-34" width="2" height="2" fill="#fff"/>
                    <rect x="4" y="-34" width="2" height="2" fill="#fff"/>
                    <!-- Smile -->
                    <rect x="-4" y="-26" width="8" height="2" fill="#333"/>
                    <!-- Chef Hat -->
                    <rect x="-14" y="-52" width="28" height="14" fill="#fff" stroke="#ddd" stroke-width="2"/>
                    <rect x="-10" y="-60" width="20" height="10" fill="#fff" stroke="#ddd" stroke-width="2"/>
                    <rect x="-6" y="-66" width="12" height="8" fill="#fff" stroke="#ddd" stroke-width="2"/>
                    <!-- Legs -->
                    <rect x="-8" y="8" width="6" height="10" fill="#333"/>
                    <rect x="2" y="8" width="6" height="10" fill="#333"/>
                </g>
            `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ADD PIXEL DECORATIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function addDecorations(island, mesNumero) {
            // Trees
            const treePositions = [
                { left: '5%', top: '20px' },
                { right: '5%', top: '30px' },
                { left: '15%', bottom: '15px' },
                { right: '15%', bottom: '20px' }
            ];

            treePositions.forEach((pos, i) => {
                const tree = document.createElement('div');
                tree.className = 'pixel-tree';
                tree.style.cssText = Object.entries(pos).map(([k, v]) => k + ':' + v).join(';');
                tree.innerHTML = `
                    <svg width="48" height="64" viewBox="0 0 48 64">
                        <!-- Trunk -->
                        <rect x="20" y="40" width="8" height="24" fill="var(--tree-trunk)"/>
                        <rect x="18" y="56" width="12" height="8" fill="var(--tree-trunk)"/>
                        <!-- Foliage layers -->
                        <rect x="8" y="28" width="32" height="16" fill="var(--tree-leaves)"/>
                        <rect x="4" y="32" width="8" height="10" fill="var(--tree-leaves)"/>
                        <rect x="36" y="32" width="8" height="10" fill="var(--tree-leaves)"/>
                        <rect x="12" y="16" width="24" height="16" fill="var(--tree-leaves)"/>
                        <rect x="16" y="6" width="16" height="14" fill="var(--tree-leaves)"/>
                        <rect x="20" y="2" width="8" height="8" fill="var(--tree-leaves)"/>
                        <!-- Highlights -->
                        <rect x="14" y="18" width="6" height="6" fill="rgba(255,255,255,0.2)"/>
                        <rect x="10" y="30" width="4" height="4" fill="rgba(255,255,255,0.2)"/>
                    </svg>
                `;
                island.appendChild(tree);
            });

            // Bushes
            const bushPositions = [
                { left: '25%', bottom: '10px' },
                { right: '25%', bottom: '15px' }
            ];

            bushPositions.forEach(pos => {
                const bush = document.createElement('div');
                bush.className = 'pixel-bush';
                bush.style.cssText = Object.entries(pos).map(([k, v]) => k + ':' + v).join(';');
                bush.innerHTML = `
                    <svg width="40" height="24" viewBox="0 0 40 24">
                        <rect x="8" y="8" width="24" height="16" fill="var(--tree-leaves)"/>
                        <rect x="4" y="12" width="8" height="10" fill="var(--tree-leaves)"/>
                        <rect x="28" y="12" width="8" height="10" fill="var(--tree-leaves)"/>
                        <rect x="12" y="4" width="16" height="8" fill="var(--tree-leaves)"/>
                        <rect x="10" y="10" width="4" height="4" fill="rgba(255,255,255,0.2)"/>
                    </svg>
                `;
                island.appendChild(bush);
            });

            // Flowers
            const flowerPositions = [
                { left: '35%', bottom: '25px' },
                { right: '35%', bottom: '30px' },
                { left: '45%', bottom: '20px' }
            ];

            const flowerColors = ['#ff6b6b', '#ffd700', '#ff69b4', '#ff4500'];
            flowerPositions.forEach((pos, i) => {
                const flower = document.createElement('div');
                flower.className = 'pixel-flower';
                flower.style.cssText = Object.entries(pos).map(([k, v]) => k + ':' + v).join(';');
                flower.style.animationDelay = (i * 0.3) + 's';
                const color = flowerColors[i % flowerColors.length];
                flower.innerHTML = `
                    <svg width="16" height="24" viewBox="0 0 16 24">
                        <rect x="7" y="12" width="2" height="12" fill="#228b22"/>
                        <rect x="4" y="4" width="8" height="8" fill="${color}"/>
                        <rect x="2" y="6" width="4" height="4" fill="${color}"/>
                        <rect x="10" y="6" width="4" height="4" fill="${color}"/>
                        <rect x="6" y="2" width="4" height="4" fill="${color}"/>
                        <rect x="6" y="10" width="4" height="4" fill="${color}"/>
                        <rect x="6" y="6" width="4" height="4" fill="#ffd700"/>
                    </svg>
                `;
                island.appendChild(flower);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER MAP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderMap(meses) {
            const container = document.getElementById('map');
            container.innerHTML = '';

            let currentMes = 1;
            meses.forEach((mes, idx) => {
                const hasActive = mes.steps.some(s => s.status === 'EM_ANDAMENTO' || s.status === 'PENDENTE_VALIDACAO');
                if (hasActive) currentMes = mes.numero || (idx + 1);
            });
            setTheme(currentMes);

            meses.forEach((mes, mIdx) => {
                const mesNumero = mes.numero || (mIdx + 1);
                const tema = TEMAS[mesNumero] || TEMAS[1];

                const total = mes.steps.length;
                const concluidos = mes.steps.filter(s => s.status === 'CONCLUIDO').length;
                const progressPercent = total > 0 ? (concluidos / total) * 100 : 0;

                const island = document.createElement('div');
                island.className = 'mes-island';
                island.innerHTML = `
                    <div class="mes-header">
                        <div class="mes-title">
                            <div class="mes-number">${mesNumero}</div>
                            <div class="mes-name">${tema.icon} ${tema.nome}</div>
                        </div>
                        <div class="mes-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <span>${concluidos}/${total}</span>
                        </div>
                    </div>
                `;

                // Create SVG
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'trilha-svg');
                svg.setAttribute('viewBox', '0 0 1000 300');
                svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

                const stepCount = mes.steps.length || 1;
                const startX = 80;
                const endX = 850;
                const castleSpace = 180;
                const availableWidth = endX - startX - castleSpace;

                // Generate serpentine path
                const points = [];
                for (let i = 0; i < stepCount; i++) {
                    const x = startX + (availableWidth / stepCount) * i + 50;
                    const y = i % 2 === 0 ? 100 : 200;
                    points.push({ x, y });
                }

                // Build path
                let pathD = `M ${startX},150`;
                points.forEach((pt, i) => {
                    if (i === 0) {
                        pathD += ` Q ${startX + 30},150 ${pt.x},${pt.y}`;
                    } else {
                        const prev = points[i - 1];
                        const midX = (prev.x + pt.x) / 2;
                        pathD += ` Q ${midX},${prev.y} ${midX},150 Q ${midX},${pt.y} ${pt.x},${pt.y}`;
                    }
                });

                const lastPoint = points[points.length - 1] || { x: startX + 50, y: 150 };
                pathD += ` Q ${lastPoint.x + 60},${lastPoint.y} ${lastPoint.x + 100},150 L ${endX - 60},150`;

                svg.innerHTML = `
                    <!-- Path Glow -->
                    <path d="${pathD}" class="path-border"/>
                    <path d="${pathD}" class="path-main"/>
                    <path d="${pathD}" class="path-detail"/>
                `;

                // Render step nodes
                mes.steps.forEach((step, sIdx) => {
                    const pt = points[sIdx];
                    if (!pt) return;

                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    const isLocked = step.status === 'BLOQUEADO';
                    const isCurrent = step.status === 'EM_ANDAMENTO';
                    g.setAttribute('class', 'step-node' + (isLocked ? ' locked' : '') + (isCurrent ? ' current' : ''));
                    g.setAttribute('transform', `translate(${pt.x}, ${pt.y})`);
                    g.innerHTML = renderPixelStep(step);

                    // Label
                    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    label.setAttribute('y', '40');
                    label.setAttribute('text-anchor', 'middle');
                    label.setAttribute('font-size', '10');
                    label.setAttribute('fill', '#fff');
                    label.setAttribute('font-family', 'Press Start 2P');
                    label.style.textShadow = '2px 2px 0 #000';
                    label.textContent = step.ordem;
                    g.appendChild(label);

                    if (step.status === 'EM_ANDAMENTO' || step.status === 'PENDENTE_VALIDACAO') {
                        avatarNode = { x: pt.x, y: pt.y, svgId: 'svg-' + mIdx, mes: mesNumero };
                    }

                    if (!isLocked) {
                        g.style.cursor = 'pointer';
                        g.addEventListener('click', () => openDrawer(step.id));
                    }

                    svg.appendChild(g);
                });

                // Castle
                const lastStep = mes.steps[mes.steps.length - 1];
                const castleCompleted = lastStep && lastStep.status === 'CONCLUIDO';
                const castle = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                castle.setAttribute('transform', `translate(${endX}, 150)`);
                castle.innerHTML = renderPixelCastle(mesNumero, castleCompleted);
                svg.appendChild(castle);

                // Avatar
                if (avatarNode && avatarNode.svgId === 'svg-' + mIdx) {
                    const avatar = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    avatar.setAttribute('transform', `translate(${avatarNode.x}, ${avatarNode.y - 40})`);
                    avatar.innerHTML = renderPixelAvatar(mesNumero);
                    svg.appendChild(avatar);
                }

                svg.id = 'svg-' + mIdx;
                island.appendChild(svg);

                addDecorations(island, mesNumero);
                container.appendChild(island);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOAD DATA
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function loadProgress() {
            try {
                const res = await fetch('/trilha/api/aluno/progresso/');
                const data = await res.json();

                document.getElementById('xp').textContent = data.total_pontos || 0;
                document.getElementById('progress').textContent = `${data.steps_concluidos || 0}/${data.total_steps || 0}`;

                if (data.mundos && data.mundos.length > 0) {
                    renderMap(data.mundos);
                } else {
                    renderDemo();
                }
            } catch (e) {
                console.error(e);
                renderDemo();
            }
        }

        function renderDemo() {
            renderMap([
                {
                    numero: 1,
                    nome: 'DESERTO DE OURO',
                    steps: [
                        { id: 1, ordem: 1, status: 'CONCLUIDO' },
                        { id: 2, ordem: 2, status: 'CONCLUIDO' },
                        { id: 3, ordem: 3, status: 'EM_ANDAMENTO' },
                        { id: 4, ordem: 4, status: 'BLOQUEADO' },
                        { id: 5, ordem: 5, status: 'BLOQUEADO' }
                    ]
                },
                {
                    numero: 2,
                    nome: 'REINO DOS DOCES',
                    steps: [
                        { id: 6, ordem: 1, status: 'BLOQUEADO' },
                        { id: 7, ordem: 2, status: 'BLOQUEADO' },
                        { id: 8, ordem: 3, status: 'BLOQUEADO' },
                        { id: 9, ordem: 4, status: 'BLOQUEADO' }
                    ]
                }
            ]);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DRAWER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function openDrawer(stepId) {
            try {
                const res = await fetch(`/trilha/api/aluno/step/${stepId}/`);
                const data = await res.json();

                document.getElementById('drawer-title').textContent = `ETAPA ${data.ordem}`;

                let html = `
                    <div class="info-card">
                        <h3>ğŸ“œ MISSÃƒO</h3>
                        <p>${data.instrucoes || 'Complete esta etapa!'}</p>
                    </div>
                    <div class="xp-badge">â­ +${data.pontos || 10} XP</div>
                `;

                if (data.feedback_anterior) {
                    html += `<div class="info-card" style="border-color:#ff4444"><h3>âš ï¸ REFAZER</h3><p>${data.feedback_anterior}</p></div>`;
                }

                if (data.status === 'EM_ANDAMENTO') {
                    const input = data.tipo_validacao === 'FOTO'
                        ? `<input type="file" name="arquivo" accept="image/*" class="form-field" required>`
                        : `<textarea name="resposta_texto" rows="4" class="form-field" placeholder="Sua resposta..." required></textarea>`;
                    html += `<form onsubmit="submitStep(event,${data.id})"><input type="hidden" name="step_id" value="${data.id}">${input}<button type="submit" class="btn-submit">ğŸš€ ENVIAR</button></form>`;
                } else if (data.status === 'PENDENTE_VALIDACAO') {
                    html += `<div class="info-card"><h3>â³ AGUARDANDO</h3><p>O mentor estÃ¡ avaliando...</p></div>`;
                } else if (data.status === 'CONCLUIDO') {
                    html += `<div class="info-card" style="border-color:#22c55e"><h3>âœ… APROVADO!</h3><p>+${data.pontos || 10} XP conquistados!</p></div>`;
                }

                document.getElementById('drawer-body').innerHTML = html;
                document.getElementById('drawer').classList.add('active');
                document.getElementById('overlay').classList.add('active');
            } catch (e) { console.error(e); }
        }

        function closeDrawer() {
            document.getElementById('drawer').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        }

        document.getElementById('overlay').addEventListener('click', closeDrawer);

        async function submitStep(e, id) {
            e.preventDefault();
            const form = e.target;
            const fd = new FormData(form);
            const btn = form.querySelector('button');
            btn.textContent = 'â³...';
            btn.disabled = true;

            try {
                const r = await fetch('/trilha/api/aluno/submeter/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: fd
                });
                if (r.ok) {
                    closeDrawer();
                    loadProgress();
                } else {
                    const d = await r.json();
                    alert('Erro: ' + (d.error || 'Tente novamente'));
                    btn.textContent = 'ğŸš€ ENVIAR';
                    btn.disabled = false;
                }
            } catch (err) {
                alert('Erro de conexÃ£o');
                btn.textContent = 'ğŸš€ ENVIAR';
                btn.disabled = false;
            }
        }

        function getCookie(n) {
            let v = null;
            document.cookie.split(';').forEach(c => {
                c = c.trim();
                if (c.startsWith(n + '=')) v = decodeURIComponent(c.substring(n.length + 1));
            });
            return v;
        }

        document.addEventListener('DOMContentLoaded', loadProgress);
    </script>
</body>

</html>