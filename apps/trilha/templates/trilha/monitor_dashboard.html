{% extends "trilha/base_monitor.html" %}

{% block content %}
<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Total Alunos -->
    <div class="glass rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400">Total de Alunos</p>
                <p class="text-3xl font-bold mt-1" id="stat-total">-</p>
            </div>
            <div class="w-12 h-12 bg-mindhub-red/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-users text-mindhub-red text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Submissões Pendentes -->
    <div class="glass rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400">Pendentes</p>
                <p class="text-3xl font-bold mt-1" id="stat-pendentes">-</p>
            </div>
            <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-clock text-yellow-500 text-xl"></i>
            </div>
        </div>
        <a href="{% url 'trilha:monitor_validar' %}" class="text-sm text-mindhub-red hover:underline mt-3 inline-block">
            Ver pendentes <i class="fas fa-arrow-right ml-1"></i>
        </a>
    </div>

    <!-- Alunos Inativos -->
    <div class="glass rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400">Inativos (7 dias)</p>
                <p class="text-3xl font-bold mt-1" id="stat-inativos">-</p>
            </div>
            <div class="w-12 h-12 bg-red-500/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
            </div>
        </div>
    </div>

    <!-- Média Geral -->
    <div class="glass rounded-xl p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-400">Nota Média</p>
                <p class="text-3xl font-bold mt-1" id="stat-media">-</p>
            </div>
            <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-line text-green-500 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Distribuição por Nota -->
    <div class="glass rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">Distribuição por Nota</h3>
        <div class="flex items-end justify-around h-48" id="chart-notas">
            <!-- Barras serão geradas via JS -->
        </div>
        <div class="flex justify-around mt-4 text-sm text-gray-400">
            <span>Nota 1</span>
            <span>Nota 2</span>
            <span>Nota 3</span>
            <span>Nota 4</span>
            <span>Nota 5</span>
        </div>
    </div>

    <!-- Progresso por Mundo -->
    <div class="glass rounded-xl p-6">
        <h3 class="text-lg font-semibold mb-4">Alunos por Progresso</h3>
        <div class="space-y-4" id="chart-mundos">
            <!-- Mundos serão geradas via JS -->
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="glass rounded-xl p-6">
    <h3 class="text-lg font-semibold mb-4">Ações Rápidas</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <a href="{% url 'trilha:monitor_graph' %}"
            class="flex items-center gap-4 p-4 bg-mindhub-dark/50 rounded-lg hover:bg-mindhub-gray/30 transition-all">
            <div class="w-10 h-10 bg-mindhub-red/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-project-diagram text-mindhub-red"></i>
            </div>
            <div>
                <p class="font-medium">Graph View</p>
                <p class="text-sm text-gray-400">Visão geral dos alunos</p>
            </div>
        </a>

        <a href="{% url 'trilha:monitor_validar' %}"
            class="flex items-center gap-4 p-4 bg-mindhub-dark/50 rounded-lg hover:bg-mindhub-gray/30 transition-all">
            <div class="w-10 h-10 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-clipboard-check text-yellow-500"></i>
            </div>
            <div>
                <p class="font-medium">Validar Submissões</p>
                <p class="text-sm text-gray-400">Aprovar/Reprovar provas</p>
            </div>
        </a>

        <a href="/admin/"
            class="flex items-center gap-4 p-4 bg-mindhub-dark/50 rounded-lg hover:bg-mindhub-gray/30 transition-all">
            <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                <i class="fas fa-cog text-purple-500"></i>
            </div>
            <div>
                <p class="font-medium">Admin Django</p>
                <p class="text-sm text-gray-400">Gerenciar dados</p>
            </div>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const CORES = {
        1: '#dc3545',
        2: '#ff9800',
        3: '#ffc107',
        4: '#7cb342',
        5: '#28a745'
    };

    async function loadDashboard() {
        try {
            const response = await fetch('/api/monitor/estatisticas/');
            const data = await response.json();

            // Stats
            document.getElementById('stat-total').textContent = data.total_alunos;
            document.getElementById('stat-pendentes').textContent = data.submissoes_pendentes;
            document.getElementById('stat-inativos').textContent = data.alunos_inativos;

            // Calcula média
            const dist = data.distribuicao_notas;
            let soma = 0, total = 0;
            for (let nota in dist) {
                soma += parseInt(nota) * dist[nota];
                total += dist[nota];
            }
            const media = total > 0 ? (soma / total).toFixed(1) : '-';
            document.getElementById('stat-media').textContent = media;

            // Chart Notas
            renderChartNotas(data.distribuicao_notas, data.total_alunos);

            // Chart Mundos
            renderChartMundos(data.progresso_mundos);

        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
        }
    }

    function renderChartNotas(distribuicao, total) {
        const container = document.getElementById('chart-notas');
        container.innerHTML = '';

        const maxVal = Math.max(...Object.values(distribuicao), 1);

        for (let nota = 1; nota <= 5; nota++) {
            const count = distribuicao[nota] || 0;
            const height = (count / maxVal) * 100;

            const bar = document.createElement('div');
            bar.className = 'flex flex-col items-center';
            bar.innerHTML = `
            <span class="text-sm font-medium mb-2">${count}</span>
            <div class="w-12 rounded-t-lg transition-all"
                 style="height: ${Math.max(height, 5)}%; background: ${CORES[nota]}"></div>
        `;
            container.appendChild(bar);
        }
    }

    function renderChartMundos(mundos) {
        const container = document.getElementById('chart-mundos');
        container.innerHTML = '';

        if (mundos.length === 0) {
            container.innerHTML = '<p class="text-gray-400 text-center">Nenhum mundo cadastrado</p>';
            return;
        }

        const maxAlunos = Math.max(...mundos.map(m => m.alunos_ativos), 1);

        mundos.forEach(mundo => {
            const percent = (mundo.alunos_ativos / maxAlunos) * 100;

            const item = document.createElement('div');
            item.innerHTML = `
            <div class="flex items-center justify-between mb-1">
                <div class="flex items-center gap-2">
                    <i class="fas fa-${mundo.icone} text-mindhub-red"></i>
                    <span class="text-sm">${mundo.nome}</span>
                </div>
                <span class="text-sm text-gray-400">${mundo.alunos_ativos} alunos</span>
            </div>
            <div class="w-full bg-mindhub-gray/30 rounded-full h-2">
                <div class="bg-mindhub-red h-2 rounded-full transition-all" style="width: ${percent}%"></div>
            </div>
        `;
            container.appendChild(item);
        });
    }

    function refreshData() {
        loadDashboard();
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
{% endblock %}