<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindLink IA - Corporativo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='estilo.css') }}">
</head>
<body>
    <div class="chat-wrapper">
        <header class="chat-header">
            <h2>MindLinküß† <span style="font-size: 0.5em; vertical-align: middle;">v2.0</span></h2>
            <p style="font-size: 0.8em; color: #666;">Conectado ao Google Drive Mindhub</p>
            <div style="text-align: right; padding: 10px 20px;">
                <button id="btn-reiniciar" class="btn-reset-base" onclick="reiniciarManual()">
                    üîÑ Atualizar Base do Drive
                </button>
            </div>
        </header>

        <div id="chat-box" class="chat-box">
            <div class="msg ia-msg">
                Ol√°! Sou seu assistente de auditoria. Como posso ajudar com os documentos da empresa hoje?
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="pergunta" placeholder="Digite sua pergunta t√©cnica..." onkeypress="verificarEnter(event)">
            <button onclick="enviarPergunta()" id="btn-enviar">
                <span>Enviar</span>
            </button>
        </div>
    </div>

    <script>
        // Fun√ß√£o para permitir o uso da tecla Enter para enviar
        function verificarEnter(e) {
            if (e.key === 'Enter') enviarPergunta();
        }

        async function enviarPergunta() {
            const input = document.getElementById('pergunta');
            const box = document.getElementById('chat-box');
            const btn = document.getElementById('btn-enviar');
            const mensagem = input.value.trim();

            if (!mensagem) return;

            // 1. Mostrar pergunta do usu√°rio na tela
            box.innerHTML += `<div class="msg user-msg">${mensagem}</div>`;
            input.value = ''; // Limpa o campo
            box.scrollTop = box.scrollHeight; // Scroll autom√°tico para baixo

            // 2. Desabilitar bot√£o enquanto a IA pensa
            btn.disabled = true;
            btn.innerText = "Pensando...";

            try {
                // 3. Chamar o servidor Flask
                const resposta = await fetch('/perguntar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mensagem: mensagem })
                });

                const dados = await resposta.json();

                // 4. Mostrar resposta da IA
                box.innerHTML += `<div class="msg ia-msg">${dados.resposta}</div>`;
                lidarComRespostaIA(dados);
                box.scrollTop = box.scrollHeight;

            } catch (erro) {
                console.error("Erro:", erro);
                box.innerHTML += `<div class="msg ia-msg" style="color: red;">‚ö†Ô∏è Erro ao conectar com o servidor da IA.</div>`;
            } finally {
                btn.disabled = false;
                btn.innerText = "Enviar";
            }
        }


        setInterval(async () => {
        const response = await fetch('/status-atualizacao');
        const data = await response.json();
        
        let alerta = document.getElementById('alerta-atualizacao');
        if (data.atualizando) {
            if (!alerta) {
                // Cria o aviso visual se ele n√£o existir
                alerta = document.createElement('div');
                alerta.id = 'alerta-atualizacao';
                alerta.style = "background: #ffcc00; color: #000; text-align: center; padding: 10px; font-weight: bold; position: fixed; top: 0; width: 100%; z-index: 1000;";
                alerta.innerText = "‚ö†Ô∏è O sistema est√° atualizando os dados do Drive. Novas informa√ß√µes estar√£o dispon√≠veis em instantes.";
                document.body.prepend(alerta);
            }
        } else if (alerta) {
            alerta.remove(); // Remove o aviso quando terminar
        }
        }, 5000);

        async function reiniciarManual() {
        const btn = document.getElementById('btn-reiniciar');
        
        if (!confirm("Deseja atualizar a base de conhecimento com os dados atuais do Google Drive? Isso pode levar alguns segundos.")) {
            return;
        }

        btn.disabled = true;
        btn.innerText = "‚è≥ Atualizando...";

        try {
            const response = await fetch('/for√ßar-atualizacao', { method: 'POST' });
            const data = await response.json();

            if (data.status === "sucesso") {
                alert("‚úÖ Base de dados atualizada com sucesso!");
            } else {
                alert("‚ùå Erro ao atualizar a base.");
            }
        } catch (error) {
            console.error("Erro:", error);
            alert("‚ùå Falha na comunica√ß√£o com o servidor.");
        } finally {
            btn.disabled = false;
            btn.innerText = "üîÑ Atualizar Base do Drive";
        }
        }

            // Fun√ß√£o chamada quando a IA responde
        function lidarComRespostaIA(dados) {
            const textoIA = dados.resposta;
            
            // 1. Exibe o texto da IA no chat
            //exibirMensagemNoChat("bot", textoIA);

            // 2. Verifica se h√° uma sugest√£o de edi√ß√£o no texto
            if (textoIA.includes("[SUGEST√ÉO DE EDI√á√ÉO]")) {
                try {
                    // Extrai os campos usando regex
                    const fileId = textoIA.match(/ID:\s*([^\n\r]+)/)[1].trim();
                    const nome = textoIA.match(/Arquivo:\s*([^\n\r]+)/)[1].trim();
                    const alteracao = textoIA.match(/Altera√ß√£o:\s*([^\n\r]+)/)[1].trim();

                    // Cria o bot√£o de confirma√ß√£o
                    criarBotaoConfirmacao(fileId, nome, alteracao);
                } catch (e) {
                    console.error("Erro ao extrair dados de edi√ß√£o:", e);
                }
            }
        }

        function criarBotaoConfirmacao(id, nome, texto) {
            const chatContainer = document.getElementById('chat-box'); 
            const btn = document.createElement('button');
            
            btn.innerHTML = `üíæ Confirmar Altera√ß√£o: <b>${nome}</b>`;
            btn.className = "btn-confirmar-edicao";
            
            btn.onclick = async function() {
                btn.disabled = true;
                btn.innerText = "‚è≥ Gravando no Drive...";

                try {
                    const resposta = await fetch('/executar-edicao', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            file_id: id,
                            nome_arquivo: nome,
                            texto: texto
                        })
                    });

                    // Tenta ler o corpo da resposta como JSON
                    const dados = await resposta.json();

                    if (resposta.ok) {
                        alert(dados.mensagem || "Sucesso!");
                        btn.remove(); 
                    } else {
                        // Prioriza exibir o erro detalhado (causa) enviado pelo servidor.py
                        console.error("Erro t√©cnico retornado pelo servidor:", dados);
                        
                        const mensagemErro = dados.causa || dados.mensagem || dados.erro || "Erro interno no servidor";
                        alert("Falha na grava√ß√£o:\n\n" + mensagemErro);
                        
                        btn.disabled = false;
                        btn.innerText = "Tentar Novamente";
                    }
                } catch (erro) {
                    console.error("Erro na comunica√ß√£o com a API:", erro);
                    alert("Erro de conex√£o: N√£o foi poss√≠vel alcan√ßar o servidor.");
                    btn.disabled = false;
                    btn.innerText = "Tentar Novamente";
                }
            };

            chatContainer.appendChild(btn);
        }


    </script>
</body>
</html>